{% extends "base.html" %}
{% block title %}{{ tool.title }} — BlinkPDF{% endblock %}
{% block meta %}{{ tool.desc }}{% endblock %}

{% block content %}
<section class="bg-gradient-to-b from-violet-50 to-white py-10">
  <div id="tool-root"
       class="max-w-6xl mx-auto px-4"
       data-tool-slug="{{ tool.slug }}">

    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
      <div>
        <div class="inline-flex items-center gap-3 px-3 py-1 rounded-full bg-violet-100 text-violet-700 text-xs font-medium mb-3">
          <div class="w-6 h-6 rounded-full bg-white flex items-center justify-center shadow-sm border border-violet-200">
            <img src="{{ url_for('static', filename='icons/' ~ tool.icon) }}"
                 alt="{{ tool.title }} icon"
                 class="w-4 h-4">
          </div>
          <span>{{ tool.slug | replace('-', ' ') | title }}</span>
        </div>
        <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">
          {{ tool.title }}
        </h1>
        <p class="text-sm sm:text-base text-slate-600 max-w-xl">
          {{ tool.desc }}
        </p>
      </div>
    </div>

    <!-- MAIN -->
    <div class="grid lg:grid-cols-2 gap-6 lg:gap-8 items-start">

      <!-- LEFT -->
      <div class="space-y-6">

        <!-- UPLOAD -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5">
          <h2 class="text-sm font-semibold text-slate-800 mb-3">
            Upload file
          </h2>

          <div id="upload-area"
               class="relative border border-dashed border-violet-200 rounded-xl p-6 text-center cursor-pointer hover:border-violet-400">

            <input
              id="file-input"
              type="file"
              name="file"
              class="absolute inset-0 opacity-0 pointer-events-none"
              {% if tool.slug in ['merge-pdf','image-to-pdf'] %}multiple{% endif %}
              accept=".pdf"
            >

            <p class="text-sm font-medium text-slate-900">
              Click to upload or drag & drop
            </p>
            <p id="file-info" class="hidden mt-2 text-xs text-slate-500">
              No file selected
            </p>
          </div>
        </div>

        <!-- FORM -->
        <form id="tool-form"
              action="{{ url_for('process_tool', slug=tool.slug) }}"
              method="post"
              enctype="multipart/form-data">

          <input type="file" name="file" id="hidden-file-input" class="hidden" multiple>
          <input type="hidden" name="page_order" id="hidden_page_order">
          <input type="hidden" name="deleted_pages" id="hidden_deleted_pages">
          <input type="hidden" name="crop_regions" id="hidden_crop_regions">

          <button type="submit"
                  class="w-full py-3 rounded-xl bg-violet-600 text-white font-semibold">
            Process {{ tool.title }}
          </button>
        </form>
      </div>

      <!-- RIGHT (PREVIEW) -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5">
        <h2 class="text-sm font-semibold mb-2">Live Preview</h2>

        <div id="preview-empty" class="text-center text-slate-500 py-10">
          No file selected
        </div>

        <div id="preview-content" class="hidden">
          <p id="preview-filename" class="text-xs mb-2"></p>
          <div id="preview-thumbnails"
               class="grid grid-cols-2 gap-3"></div>
        </div>

      </div>
    </div>
  </div>
</section>

<!-- PDFJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const root = document.getElementById('tool-root');
  if (!root) return;

  // ✅ FIXED
  const toolSlug = root.getAttribute('data-tool-slug');

  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');
  const hiddenInput = document.getElementById('hidden-file-input');

  const previewEmpty = document.getElementById('preview-empty');
  const previewContent = document.getElementById('preview-content');
  const previewName = document.getElementById('preview-filename');
  const previewThumbs = document.getElementById('preview-thumbnails');
  const fileInfo = document.getElementById('file-info');

  // ✅ REQUIRED FOR PDFJS
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';

  uploadArea.addEventListener('click', function () {
    fileInput.value = '';
    fileInput.click();
  });

  fileInput.addEventListener('change', function (e) {
    if (!e.target.files.length) return;

    const file = e.target.files[0];
    console.log('FILE SELECTED:', file.name);

    hiddenInput.files = e.target.files;

    fileInfo.classList.remove('hidden');
    fileInfo.textContent = file.name;

    if (!file.name.toLowerCase().endsWith('.pdf')) {
      previewEmpty.textContent = "Preview only works for PDF files";
      return;
    }

    renderPdf(file);
  });

  async function renderPdf(file) {
    previewThumbs.innerHTML = '';
    previewEmpty.classList.add('hidden');
    previewContent.classList.remove('hidden');
    previewName.textContent = file.name;

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    for (let i = 1; i <= Math.min(6, pdf.numPages); i++) {
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({ scale: 0.4 });

      const canvas = document.createElement('canvas');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      const ctx = canvas.getContext('2d');

      await page.render({
        canvasContext: ctx,
        viewport: viewport
      }).promise;

      previewThumbs.appendChild(canvas);
    }
  }

});
</script>

{% endblock %}

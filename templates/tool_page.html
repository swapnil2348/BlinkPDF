{% extends "base.html" %}

{% block title %}{{ tool.title }} — BlinkPDF{% endblock %}
{% block meta %}{{ tool.desc }} Online with BlinkPDF tools{% endblock %}

{% block content %}

<section class="bg-gradient-to-b from-violet-100 to-transparent rounded-2xl p-6 mb-6 shadow-sm">
  <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 flex items-center gap-3">
    <img src="{{ url_for('static', filename='icons/' + tool.icon) }}" class="h-10 w-10">
    {{ tool.title }}
  </h1>
  <p class="text-gray-600 max-w-2xl mt-2">{{ tool.desc }}</p>
</section>

<form method="POST"
      action="{{ url_for('process', slug=tool.slug) }}"
      enctype="multipart/form-data"
      class="bg-white rounded-2xl border shadow-md p-6 space-y-6">

<!-- FILE UPLOAD -->
<div>
  <label class="font-semibold block mb-2">Upload File(s)</label>
  <input type="file" id="fileInput" name="file" multiple required class="hidden">

  <div id="dropZone"
       class="w-full border-2 border-dashed border-violet-300 p-8 rounded-xl bg-violet-50 text-center cursor-pointer">
    Click or Drop files here
  </div>

  <ul id="fileList" class="mt-4 space-y-2"></ul>

  <!-- LIVE PREVIEW -->
  <div id="preview-container"
       class="w-full h-96 border rounded-xl bg-gray-50 flex items-center justify-center mb-4 overflow-hidden relative">
    <canvas id="pdf-preview"></canvas>

    <!-- Watermark live text -->
    <div id="wm-preview"
         class="absolute text-gray-600 font-bold pointer-events-none opacity-40 hidden">
    </div>
  </div>

  <p class="text-xs text-gray-500 mt-2">
    Drag files up or down to rearrange the order
  </p>
</div>

<!-- ================= TOOL SETTINGS ================= -->

{% if tool.slug == "compress-pdf" %}
<div class="p-4 bg-gray-50 rounded-xl border">
  <h3 class="font-semibold mb-2">Compression Level</h3>
  <select name="level" id="compression_level" class="border p-2 rounded w-full">
    <option value="low">Low (Best Quality)</option>
    <option value="medium">Medium (Balanced)</option>
    <option value="high">High (Smallest Size)</option>
  </select>
</div>
{% endif %}

{% if tool.slug in ["crop-pdf","resize-pdf"] %}
<div class="p-4 bg-gray-50 rounded-xl border grid grid-cols-2 gap-3">
  <input type="number" name="width" id="width" placeholder="Width (px)" class="border p-2 rounded">
  <input type="number" name="height" id="height" placeholder="Height (px)" class="border p-2 rounded">
</div>
{% endif %}

{% if tool.slug == "rotate-pdf" %}
<div class="p-4 bg-gray-50 rounded-xl border">
  <label class="text-sm font-semibold">Angle</label>
  <select name="angle" id="angle" class="border p-2 rounded w-full">
    <option value="0">0°</option>
    <option value="90">90°</option>
    <option value="180">180°</option>
    <option value="270">270°</option>
  </select>
</div>
{% endif %}

{% if tool.slug == "protect-pdf" or tool.slug == "unlock-pdf" %}
<div class="p-4 bg-gray-50 rounded-xl border">
  <input type="password" name="password" placeholder="Enter password"
         class="border p-2 rounded w-full">
</div>
{% endif %}

{% if tool.slug == "watermark-pdf" %}
<div class="p-4 bg-gray-50 rounded-xl border space-y-2">
  <input type="text" name="text" id="wm_text" placeholder="Watermark text"
         class="border p-2 rounded w-full">

  <div class="flex gap-2">
    <input type="number" name="x" id="wm_x" placeholder="X" class="border p-2 rounded w-24">
    <input type="number" name="y" id="wm_y" placeholder="Y" class="border p-2 rounded w-24">
    <input type="number" name="size" id="wm_size" placeholder="Size" class="border p-2 rounded w-24">
  </div>
</div>
{% endif %}

{% if tool.slug == "sign-pdf" %}
<div class="p-4 bg-gray-50 rounded-xl border space-y-2">
  <input type="file" name="signature" class="border p-2 rounded w-full">
  <input type="text" name="text" placeholder="Signature Name" class="border p-2 rounded w-full">
</div>
{% endif %}

<!-- PROCESS BUTTON -->
<div class="flex justify-end">
  <button class="bg-violet-600 hover:bg-violet-700 text-white font-semibold px-8 py-3 rounded-xl shadow-lg">
    Process {{ tool.title }}
  </button>
</div>

</form>

<!-- SEO ABOUT -->
<div class="mt-10 text-sm text-gray-600">
  <h2 class="font-bold text-lg mb-2">About {{ tool.title }}</h2>
  {{ tool.desc }} securely online with BlinkPDF without installing software.
</div>

<!-- RANDOM TOOL SUGGESTIONS -->
<div class="mt-10">
  <h2 class="font-bold mb-4 text-xl">Try Other Tools</h2>

  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
    {% for t in random_tools %}
    <a href="{{ t.url if t.url else url_for('tool_page', slug=t.slug) }}"
       class="bg-white rounded-xl shadow p-3 text-center">
      <img src="{{ url_for('static', filename='icons/' + t.icon) }}" class="h-8 mx-auto mb-2">
      <span class="text-xs font-semibold">{{ t.title }}</span>
    </a>
    {% endfor %}
  </div>
</div>

<!-- SORT + PREVIEW + LIVE EFFECTS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
const fileInput = document.getElementById("fileInput");
const dropZone = document.getElementById("dropZone");
const fileList = document.getElementById("fileList");
const canvas = document.getElementById("pdf-preview");
const ctx = canvas.getContext("2d");
const wmBox = document.getElementById("wm-preview");

let filesArray = [];
let pdfDoc = null;
let currentAngle = 0;

dropZone.onclick = () => fileInput.click();

fileInput.onchange = (e) => {
  filesArray = [...e.target.files];
  renderFiles();
  if (filesArray[0]) loadPreview(filesArray[0]);
}

function renderFiles(){
  fileList.innerHTML="";
  filesArray.forEach((f,i)=>{
    const li=document.createElement("li");
    li.className="bg-gray-100 p-2 rounded flex justify-between";
    li.innerHTML=`${f.name}<button onclick="removeFile(${i})">✕</button>`;
    fileList.appendChild(li);
  });
  Sortable.create(fileList,{animation:150});
}

function removeFile(i){
  filesArray.splice(i,1);
  renderFiles();
}

function loadPreview(file){
  const reader = new FileReader();
  reader.onload = function() {
    const typedarray = new Uint8Array(this.result);
    pdfjsLib.getDocument(typedarray).promise.then(function(pdf){
      pdfDoc = pdf;
      renderPage();
    });
  };
  reader.readAsArrayBuffer(file);
}

function renderPage(){
  if(!pdfDoc) return;
  pdfDoc.getPage(1).then(page=>{
    const viewport = page.getViewport({ scale: 1, rotation: currentAngle });
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    page.render({canvasContext: ctx, viewport});
  });
}

/* LIVE ROTATION */
const angleInput = document.getElementById("angle");
if(angleInput){
  angleInput.onchange = ()=>{
    currentAngle = parseInt(angleInput.value);
    renderPage();
  };
}

/* LIVE RESIZE / CROP */
const widthInput = document.getElementById("width");
const heightInput = document.getElementById("height");

if(widthInput && heightInput){
  widthInput.oninput = heightInput.oninput = ()=>{
    canvas.style.width = widthInput.value + "px";
    canvas.style.height = heightInput.value + "px";
  }
}

/* LIVE WATERMARK */
const wmText = document.getElementById("wm_text");
const wmX = document.getElementById("wm_x");
const wmY = document.getElementById("wm_y");
const wmSize = document.getElementById("wm_size");

if(wmText){
  wmText.oninput = ()=>{
    wmBox.style.display="block";
    wmBox.innerText = wmText.value;
  }
  wmX.oninput = ()=> wmBox.style.left = wmX.value+"px";
  wmY.oninput = ()=> wmBox.style.top = wmY.value+"px";
  wmSize.oninput = ()=> wmBox.style.fontSize = wmSize.value+"px";
}
</script>

{% endblock %}

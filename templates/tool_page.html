{% extends "base.html" %}
{% block title %}{{ tool.title }} — BlinkPDF{% endblock %}
{% block meta %}{{ tool.desc }}{% endblock %}

{% block content %}
<section class="bg-gradient-to-b from-violet-50 to-white py-10">
  <div id="tool-root" class="max-w-6xl mx-auto px-4" data-tool-slug="{{ tool.slug }}">

    <input type="hidden" id="crop_x" name="crop_x">
    <input type="hidden" id="crop_y" name="crop_y">
    <input type="hidden" id="crop_w" name="crop_w">
    <input type="hidden" id="crop_h" name="crop_h">
    <input type="hidden" id="page_order" name="page_order">

    <div class="grid lg:grid-cols-2 gap-6 lg:gap-8 items-start">

      <!-- LEFT -->
      <div class="space-y-6">

        <!-- UPLOAD -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
          <input id="file-input" type="file" class="w-full">
        </div>

        <!-- ADVANCED -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">

          {% if tool.slug == 'rotate-pdf' %}
          <label class="font-semibold">Rotate</label>
          <div class="flex gap-2 mb-2">
            <button class="rotate-btn" data-direction="-90">-90°</button>
            <button class="rotate-btn" data-direction="90">+90°</button>
            <span id="rotation-label" class="ml-auto font-bold text-violet-600">0°</span>
          </div>
          <input id="rotation-slider" type="range" min="0" max="270" step="90" value="0">
          <input type="hidden" id="hidden_rotation" name="rotation_angle">
          {% endif %}

          {% if tool.slug == 'watermark-pdf' %}
          <label class="font-semibold">Watermark</label>
          <input id="watermark_text" type="text" class="w-full border px-3 py-2" placeholder="CONFIDENTIAL">
          <input type="hidden" id="hidden_watermark_text" name="watermark_text">
          {% endif %}

          {% if tool.slug == 'crop-pdf' %}
          <p class="text-xs text-gray-500">Drag on preview to crop area</p>
          {% endif %}

        </div>

        <form action="{{ url_for('process_tool', slug=tool.slug) }}" method="post" enctype="multipart/form-data">
          <input type="file" name="file" id="hidden-file" class="hidden">
          <button type="submit" class="w-full bg-violet-600 text-white py-3 rounded-xl">
            Process {{ tool.title }}
          </button>
        </form>
      </div>

      <!-- RIGHT PREVIEW -->
      <div class="bg-white p-4 rounded-2xl shadow-sm">
        <h3 class="font-semibold mb-2">Live preview</h3>

        <div id="preview-area" class="border border-dashed min-h-[300px] flex flex-wrap gap-3 p-2 relative"></div>
        <p class="text-xs text-gray-400 mt-2">Live preview enabled</p>
      </div>

    </div>
  </div>
</section>


<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
let currentRotation = 0;
const preview = document.getElementById("preview-area");
const tool = document.getElementById("tool-root").dataset.toolSlug;

pdfjsLib.GlobalWorkerOptions.workerSrc =
 "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js";

document.getElementById("file-input").addEventListener("change", function(e){
  const file = e.target.files[0];
  document.getElementById("hidden-file").files = this.files;

  preview.innerHTML = "";

  const reader = new FileReader();
  reader.onload = async function(){
    const pdf = await pdfjsLib.getDocument({data: reader.result}).promise;
    const max = Math.min(6, pdf.numPages);

    for(let i = 1; i <= max; i++){
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({scale: 0.3});

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({canvasContext: context, viewport}).promise;
      canvas.style.transform = "rotate("+currentRotation+"deg)";

      const box = document.createElement("div");
      box.className = "relative thumb-wrapper border p-1 rounded";
      box.dataset.index = i;

      const badge = document.createElement("div");
      badge.className = "absolute top-1 left-1 bg-black text-white text-xs px-1 rounded";
      badge.innerText = i;

      box.appendChild(badge);
      box.appendChild(canvas);

      // Delete + reorder tools
      if(["organize-pdf","split-pdf","extract-pages"].includes(tool)){
        const del = document.createElement("button");
        del.innerText = "✖";
        del.className = "absolute top-1 right-1 bg-red-500 text-white px-1 rounded text-xs";
        del.onclick = ()=>{ box.remove(); updateOrder(); }
        box.appendChild(del);

        const drag = document.createElement("div");
        drag.innerText = "☰";
        drag.className = "absolute bottom-1 left-1 bg-gray-200 px-1 rounded cursor-move";
        box.appendChild(drag);
      }

      // Watermark
      if(tool === "watermark-pdf"){
        const wm = document.createElement("div");
        wm.className = "absolute inset-0 flex items-center justify-center text-violet-400 font-bold opacity-30";
        wm.innerText = document.getElementById("watermark_text").value;
        box.appendChild(wm);
      }

      // Crop tool
      if(tool === "crop-pdf"){
        canvas.addEventListener("mousedown", startCrop);
        canvas.addEventListener("mousemove", drawCrop);
        canvas.addEventListener("mouseup", endCrop);
      }

      preview.appendChild(box);
    }

    if(["organize-pdf","split-pdf","extract-pages"].includes(tool)){
      new Sortable(preview, {animation:150, onEnd:updateOrder});
    }
  };

  reader.readAsArrayBuffer(file);
});


function updateOrder(){
  let order=[];
  document.querySelectorAll(".thumb-wrapper").forEach((t,i)=>{
    order.push(t.dataset.index);
  });
  document.getElementById("page_order").value = order.join(",");
}


/* ==== ROTATE ==== */
document.querySelectorAll(".rotate-btn").forEach(btn=>{
  btn.onclick=()=>{
    currentRotation=(currentRotation+parseInt(btn.dataset.direction))%360;
    if(currentRotation<0) currentRotation+=360;
    document.getElementById("hidden_rotation").value=currentRotation;
    document.getElementById("rotation-label").innerText=currentRotation+"°";
    document.querySelectorAll("canvas").forEach(c=>{
      c.style.transform="rotate("+currentRotation+"deg)";
    })
  }
})


/* ==== WATERMARK ==== */
const wm = document.getElementById("watermark_text");
if(wm){
  wm.addEventListener("input",()=>{
    document.getElementById("hidden_watermark_text").value=wm.value;
    document.querySelectorAll(".thumb-wrapper div:last-child").forEach(t=>{
      t.innerText=wm.value;
    })
  })
}


/* ==== CROP ==== */
let startX, startY, cropBox;
function startCrop(e){
  cropBox=document.createElement("div");
  cropBox.style.border="2px dashed #7c3aed";
  cropBox.style.position="absolute";
  cropBox.style.left=e.offsetX+"px";
  cropBox.style.top=e.offsetY+"px";
  e.target.parentElement.appendChild(cropBox);
  startX=e.offsetX;
  startY=e.offsetY;
}
function drawCrop(e){
  if(!cropBox) return;
  let w=e.offsetX-startX, h=e.offsetY-startY;
  cropBox.style.width=Math.abs(w)+"px";
  cropBox.style.height=Math.abs(h)+"px";
}
function endCrop(e){
  if(!cropBox) return;
  document.getElementById("crop_x").value=startX;
  document.getElementById("crop_y").value=startY;
  document.getElementById("crop_w").value=Math.abs(e.offsetX-startX);
  document.getElementById("crop_h").value=Math.abs(e.offsetY-startY);
  cropBox=null;
}
</script>
{% endblock %}

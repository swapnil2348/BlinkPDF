{% extends "base.html" %}
{% block title %}{{ tool.title }} — BlinkPDF{% endblock %}
{% block meta %}{{ tool.desc }}{% endblock %}

{% block content %}
<section class="bg-gradient-to-b from-violet-50 to-white py-10">
  <div id="tool-root"
       class="max-w-6xl mx-auto px-4"
       data-tool-slug="{{ tool.slug }}">

    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
      <div>
        <div class="inline-flex items-center gap-3 px-3 py-1 rounded-full bg-violet-100 text-violet-700 text-xs font-medium mb-3">
          <div class="w-6 h-6 rounded-full bg-white flex items-center justify-center shadow-sm border border-violet-200">
            <img src="{{ url_for('static', filename='icons/' ~ tool.icon) }}"
                 alt="{{ tool.title }} icon"
                 class="w-4 h-4">
          </div>
          <span>{{ tool.slug | replace('-', ' ') | title }}</span>
        </div>
        <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">{{ tool.title }}</h1>
        <p class="text-sm sm:text-base text-slate-600 max-w-xl">{{ tool.desc }}</p>
      </div>

      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
          Fast processing
        </span>
        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-100">
          <span class="w-1.5 h-1.5 rounded-full bg-violet-400"></span>
          Secure & private
        </span>
        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-100">
          No signup
        </span>
      </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-6 lg:gap-8 items-start">

      <!-- LEFT SIDE -->
      <div class="space-y-6">

        <!-- Upload -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5">
          <h2 class="text-sm font-semibold text-slate-800 mb-3 flex items-center justify-between">
            Upload file{% if tool.slug == 'merge-pdf' or tool.slug == 'image-to-pdf' %}s{% endif %}
            <span class="text-[11px] uppercase tracking-wide text-slate-400">Step 1</span>
          </h2>

          <div id="upload-area"
               class="relative border border-dashed border-violet-200 rounded-xl p-4 sm:p-6 text-center cursor-pointer hover:border-violet-400 transition group">

            <input type="file"
                   id="file-input"
                   name="files"
                   {% if tool.slug in ['merge-pdf','image-to-pdf'] %}multiple{% endif %}
                   required
                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">

            <div class="flex flex-col items-center gap-3 pointer-events-none">
              <div class="w-11 h-11 rounded-2xl bg-violet-50 flex items-center justify-center border border-violet-100 group-hover:bg-violet-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-violet-500" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 16V4m0 0L8 8m4-4 4 4M6 16h12a2 2 0 0 1 2 2v1a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-1a2 2 0 0 1 2-2Z"/>
                </svg>
              </div>

              <div class="space-y-0.5">
                <p class="text-sm font-medium text-slate-900">
                  Click to upload{% if tool.slug in ['merge-pdf','image-to-pdf'] %} files{% else %} file{% endif %} or drag & drop
                </p>
                <p class="text-[11px] text-slate-500">
                  {% if tool.slug in ['word-to-pdf','excel-to-pdf','powerpoint-to-pdf'] %}
                    Supports DOCX, PPTX, XLSX · Max 500MB
                  {% elif tool.slug == 'image-to-pdf' or tool.slug == 'background-remover' %}
                    Supports JPG, PNG, WEBP · Max 500MB
                  {% else %}
                    Supports PDF · Max 500MB
                  {% endif %}
                </p>
              </div>

              <div id="file-info" class="hidden text-xs text-slate-500 bg-slate-50 border border-slate-100 rounded-full px-3 py-1 mt-1 max-w-full truncate">
                No file selected
              </div>
            </div>
          </div>
        </div>

        <!-- Process form -->
        <form id="tool-form" action="{{ url_for('process_tool', slug=tool.slug) }}" method="POST" enctype="multipart/form-data">

          <!-- ✅ FIX: name is now files -->
          <input type="file"
                 name="files"
                 id="hidden-file-input"
                 class="hidden"
                 {% if tool.slug in ['merge-pdf','image-to-pdf'] %}multiple{% endif %}>

          <button type="submit"
                  class="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-violet-600 hover:bg-violet-700 text-white text-sm font-semibold py-3.5 shadow-sm shadow-violet-500/30">
            Process {{ tool.title }}
          </button>

        </form>
      </div>

      <!-- RIGHT: LIVE PREVIEW -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5 flex flex-col h-full">

        <h2 class="text-sm font-semibold text-slate-800 mb-2">Live preview</h2>

        <div id="preview-wrapper"
             class="flex-1 min-h-[220px] rounded-xl border border-dashed border-slate-200 bg-slate-50/60 flex items-center justify-center">

          <div id="preview-content" class="hidden w-full h-full flex items-center justify-center">
            <canvas id="preview-canvas" class="block bg-slate-100 w-full object-contain"></canvas>
          </div>

          <div id="preview-empty-state" class="text-center text-xs text-slate-500">
            No file selected yet
          </div>

        </div>
      </div>

    </div>
  </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){

  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');
  const hiddenInput = document.getElementById('hidden-file-input');
  const fileInfo = document.getElementById('file-info');

  const previewWrapper = document.getElementById('preview-wrapper');
  const previewCanvas = document.getElementById('preview-canvas');
  const previewContent = document.getElementById('preview-content');
  const previewEmpty = document.getElementById('preview-empty-state');

  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  }

  uploadArea.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', function(){
    const files = fileInput.files;

    if(!files.length) return;

    // copy to hidden input
    const dt = new DataTransfer();
    for(let f of files) dt.items.add(f);
    hiddenInput.files = dt.files;

    fileInfo.classList.remove('hidden');
    fileInfo.textContent = files.length === 1
      ? files[0].name
      : files.length + ' files selected';

    const first = files[0];

    if(!first.name.toLowerCase().endsWith('.pdf')) return;

    const reader = new FileReader();
    reader.onload = async function(){
      const typedarray = new Uint8Array(this.result);

      const pdf = await pdfjsLib.getDocument(typedarray).promise;
      const page = await pdf.getPage(1);

      const containerWidth = previewWrapper.clientWidth - 20;
      const unscaled = page.getViewport({ scale: 1 });
      const scale = containerWidth / unscaled.width;

      const viewport = page.getViewport({ scale });

      const canvas = previewCanvas;
      const ctx = canvas.getContext('2d');

      canvas.width = viewport.width;
      canvas.height = viewport.height;

      previewEmpty.classList.add('hidden');
      previewContent.classList.remove('hidden');

      await page.render({
        canvasContext: ctx,
        viewport: viewport
      }).promise;

    };

    reader.readAsArrayBuffer(first);
  });

});
</script>
{% endblock %}

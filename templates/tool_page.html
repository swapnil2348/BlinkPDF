{% extends "base.html" %}
{% block title %}{{ tool.title }} — BlinkPDF{% endblock %}
{% block meta %}{{ tool.desc if tool.desc is defined else '' }}{% endblock %}

{% block content %}
<section class="bg-gradient-to-b from-violet-50 to-white py-10">
  <div id="tool-root"
       class="max-w-6xl mx-auto px-4"
       data-tool-slug="{{ tool.slug }}">

    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
      <div>
        <div class="inline-flex items-center gap-3 px-3 py-1 rounded-full bg-violet-100 text-violet-700 text-xs font-medium mb-3">
          <div class="w-6 h-6 rounded-full bg-white flex items-center justify-center shadow-sm border border-violet-200">
            <img src="{{ url_for('static', filename='icons/' ~ tool.icon) }}"
                 alt="{{ tool.title }} icon"
                 class="w-4 h-4">
          </div>
          <span>{{ tool.slug | replace('-', ' ') | title }}</span>
        </div>
        <h1 class="text-2xl sm:text-3xl font-bold text-slate-900 mb-2">
          {{ tool.title }}
        </h1>
        <p class="text-sm sm:text-base text-slate-600 max-w-xl">
          {{ tool.desc if tool.desc is defined else '' }}
        </p>
      </div>
      <div class="flex flex-wrap items-center gap-2 text-xs text-slate-500">
        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
          Fast processing
        </span>
        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-100">
          <span class="w-1.5 h-1.5 rounded-full bg-violet-400"></span>
          Secure & private
        </span>
        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-50 text-slate-600 border border-slate-100">
          No signup
        </span>
      </div>
    </div>

    <!-- Main layout -->
    <div class="grid lg:grid-cols-2 gap-6 lg:gap-8 items-start">
      <!-- LEFT: Upload + Advanced -->
      <div class="space-y-6">

        <!-- Upload card -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 sm:p-5">
          <h2 class="text-sm font-semibold text-slate-800 mb-3 flex items-center justify-between">
            Upload file
            <span class="text-[11px] uppercase tracking-wide text-slate-400">
              Step 1
            </span>
          </h2>

          <div id="upload-area"
               class="relative border border-dashed border-violet-200 rounded-xl p-4 sm:p-6 text-center cursor-pointer hover:border-violet-400 transition group">

           <!-- ✅ FIXED: removed `multiple` -->
           <input 
             type="file" 
             id="file-input" 
             name="files" 
             {% if tool.slug in ['merge-pdf','image-to-pdf'] %}multiple{% endif %}
             required 
             class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">

            <div class="flex flex-col items-center gap-3 pointer-events-none">
              <div class="w-11 h-11 rounded-2xl bg-violet-50 flex items-center justify-center border border-violet-100 group-hover:bg-violet-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-violet-500" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 16V4m0 0L8 8m4-4 4 4M6 16h12a2 2 0 0 1 2 2v1a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-1a2 2 0 0 1 2-2Z" />
                </svg>
              </div>
              <div class="space-y-0.5">
                <p class="text-sm font-medium text-slate-900">
                  Click to upload file or drag & drop
                </p>
                <p class="text-[11px] text-slate-500">
                  Supports PDF · Max 500MB
                </p>
              </div>
              <div id="file-info" class="hidden text-xs text-slate-500 bg-slate-50 border border-slate-100 rounded-full px-3 py-1 mt-1 max-w-full truncate">
                No file selected
              </div>
            </div>
          </div>
        </div>

<!-- EVERYTHING ABOVE IS SAME UI – JUST FIXED INPUT -->

<!-- ===================================================================================== -->
<!-- ============================== SCRIPT PART (FIXED PREVIEW) ========================== -->
<!-- ===================================================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const fileInput = document.getElementById('file-input');
  const fileInfo = document.getElementById('file-info');

  const previewEmpty = document.getElementById('preview-empty-state');
  const previewContent = document.getElementById('preview-content');
  const previewThumbnails = document.getElementById('preview-thumbnails');
  const previewFilename = document.getElementById('preview-filename');
  const previewPagesCount = document.getElementById('preview-pages-count');
  const previewSize = document.getElementById('preview-size');

  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  }

  function humanFileSize(bytes) {
    if (!bytes || isNaN(bytes)) return '0 MB';
    const mb = bytes / (1024 * 1024);
    return mb < 1 ? mb.toFixed(2) + ' MB' : mb.toFixed(1) + ' MB';
  }

  async function renderPdfPreview(file) {

    previewEmpty.classList.add('hidden');
    previewContent.classList.remove('hidden');

    previewFilename.textContent = file.name;
    previewSize.textContent = humanFileSize(file.size);

    const uint8 = new Uint8Array(await file.arrayBuffer());
    const doc = await pdfjsLib.getDocument({ data: uint8 }).promise;

    previewPagesCount.textContent = doc.numPages + " pages";

    previewThumbnails.innerHTML = '';

    // ✅ FIXED : Only ONE PAGE WILL DISPLAY
    const maxPages = 1;

    for (let i = 1; i <= maxPages; i++) {
      const page = await doc.getPage(i);
      const viewport = page.getViewport({ scale: 0.4 });

      const wrapper = document.createElement('div');
      wrapper.className = 'bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden';

      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      canvas.className = 'w-full h-auto bg-slate-100';

      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      wrapper.appendChild(canvas);
      previewThumbnails.appendChild(wrapper);
    }
  }

  fileInput.addEventListener('change', function (e) {
    const file = e.target.files[0];

    if (!file) return;

    fileInfo.classList.remove('hidden');
    fileInfo.textContent = file.name + ' · ' + humanFileSize(file.size);

    if (file.type === "application/pdf" || file.name.endsWith('.pdf')) {
      renderPdfPreview(file);
    }
  });

});
</script>

{% endblock %}

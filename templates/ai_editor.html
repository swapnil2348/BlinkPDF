{% extends "base.html" %}
{% block seo_title %}AI PDF Editor - BlinkPDF{% endblock %}
{% block seo_desc %}Edit, sign, OCR and modify PDFs online for free{% endblock %}

{% block content %}
<style>
  .tool-btn{
    padding:6px 14px;
    border-radius:6px;
    background:#f3f4f6;
    font-size:14px;
    border:1px solid #e5e7eb;
  }
  .tool-btn:hover{ background:#e5e7eb; }
  .tool-btn.active { background:#7c3aed; color:white; }
  
  /* MOBILE TOUCH FIX FOR PDF CANVAS */
#pdf-canvas {
  touch-action: none;          /* allow custom gestures */
  -ms-touch-action: none;
  user-select: none;
  -webkit-user-select: none;
  -webkit-tap-highlight-color: transparent;
}

</style>

<section class="max-w-7xl mx-auto px-4 py-8">

  <h1 class="text-3xl font-bold mb-4">AI PDF Editor (PRO)</h1>

  <!-- Upload -->
<div class="bg-white p-6 rounded-xl shadow border mb-6">

  <form id="uploadForm" class="flex flex-col sm:flex-row gap-4">

    <input
      type="file"
      id="pdfUpload"
      accept="application/pdf"
      required
      class="border p-2 rounded flex-1"
    >

    <button
      type="button"
      id="uploadBtn"
      class="bg-violet-600 text-white px-6 py-2 rounded hover:bg-violet-700 w-full sm:w-auto"
    >
      Upload & Start
    </button>

  </form>

  <p id="status" class="text-sm mt-3 text-violet-600 font-semibold"></p>

</div>

    <!-- Thumbnails -->
    <div class="col-span-12 md:col-span-2 bg-white border rounded-xl p-3 overflow-y-auto max-h-[600px]" id="thumbs">
      <p class="text-xs text-gray-400 text-center">No file loaded</p>
    </div>

    <!-- Main editor -->
    <div class="col-span-12 md:col-span-10 space-y-3">

      <!-- Toolbar -->
      <div class="bg-white p-3 rounded-xl shadow border flex gap-2 flex-wrap items-center">

        <!-- Core tools -->
        <button class="tool-btn" onclick="openRewriteBox()">‚ú® Rewrite</button>
        <button class="tool-btn" onclick="openFindReplace()">üîÅ Find & Replace</button>
        <button class="tool-btn" onclick="enableDeleteMode()">‚ùå Delete text</button>
        <button class="tool-btn" onclick="addStickyNote()">üí¨ Comment</button>
        <button class="tool-btn" onclick="openParagraphEditor()">¬∂ Paragraph editor</button>
        <button class="tool-btn" onclick="startSignature()">‚úç Draw Sign</button>
        <button class="tool-btn" onclick="runOCR()">üîé OCR</button>

        <!-- Zoom / crop -->
        <button class="tool-btn" onclick="zoomOut()">üîç -</button>
        <button class="tool-btn" onclick="zoomIn()">üîé +</button>
        <button class="tool-btn" onclick="toggleCropMode()">‚úÇ Crop</button>

        <!-- NEW: History tools -->
        <button class="tool-btn" onclick="undo()">‚Ü© Undo</button>
        <button class="tool-btn" onclick="redo()">‚Ü™ Redo</button>
        <button class="tool-btn" onclick="resetPage()">üßº Reset Page</button>

        <!-- Save -->
        <button class="tool-btn bg-indigo-600 text-white ml-auto" onclick="saveFullPDF()">üíæ Save FULL PDF</button>
      </div>

      <!-- Page navigation -->
      <div class="flex items-center justify-between bg-white p-3 rounded-xl shadow border text-sm">
        <div class="flex items-center gap-2">
          <button class="tool-btn" onclick="prevPage()">‚¨Ö Prev</button>
          <button class="tool-btn" onclick="nextPage()">Next ‚û°</button>
        </div>
        <div class="text-xs sm:text-sm text-gray-600">
          Page <span id="pageNum">-</span> / <span id="pageCount">-</span>
        </div>
      </div>

      <!-- AI Rewrite -->
      <div id="rewriteBox" class="hidden bg-white p-3 border rounded mb-3">
        <textarea id="rewriteInput" class="border w-full rounded p-2" rows="3"
          placeholder="Enter text to rewrite..."></textarea>
        <button onclick="rewriteText()"
          class="bg-violet-600 text-white p-2 mt-2 rounded w-full">
          Rewrite & Add
        </button>
      </div>

      <!-- Find & Replace -->
      <div id="findReplaceBox" class="hidden bg-white p-3 border rounded mb-3">
        <input id="findText" class="border p-2 w-full mb-2" placeholder="Find text">
        <input id="replaceText" class="border p-2 w-full mb-2" placeholder="Replace with">
        <button onclick="replaceTextAll()"
          class="bg-indigo-600 text-white px-3 py-1 rounded w-full">
          Replace All
        </button>
      </div>

      <!-- Paragraph editor -->
      <div id="paraBox" class="hidden bg-white p-3 border rounded mb-3">
        <p class="text-sm mb-1 text-gray-700">Edit paragraph of selected text:</p>
        <textarea id="paraInput" class="border w-full rounded p-2" rows="4"></textarea>
        <button onclick="applyParagraphEdit()"
          class="bg-indigo-600 text-white px-3 py-1 rounded w-full mt-2">
          Apply to selected text block
        </button>
      </div>

      <!-- Signature pad -->
      <div id="signBox" class="hidden bg-white border p-3 rounded mb-3">
        <canvas id="signCanvas" class="border bg-white w-full h-40"></canvas>
        <button onclick="addSignatureToPDF()"
          class="bg-green-600 text-white w-full mt-2 rounded p-1">
          Add Signature to PDF
        </button>
      </div>

      <!-- Canvas wrapper (horizontal scroll for mobile) -->
      <div class="bg-gray-100 p-2 md:p-4 rounded-xl overflow-scroll touch-pan touch-pinch"
             style="max-height:75vh; -webkit-overflow-scrolling: touch;">
            <div style="min-width:100%; display:flex; justify-content:center;">
        <div class="bg-white shadow-xl p-4 rounded-xl min-w-[800px] max-w-full">
          <canvas id="pdf-canvas"></canvas>
        </div>
      </div>

    </div>
  </div>
  </div>
</section>


<!-- ================== RANDOM TOOL SUGGESTION GRID ================== -->
<section class="max-w-7xl mx-auto mt-16">
  <h2 class="text-xl font-black mb-5 text-slate-900 dark:text-slate-100">
    Explore More Tools
  </h2>

  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">

    <!-- ‚úÖ 10 RANDOM NORMAL TOOLS (SAFE METHOD) -->
    {% for tool in random_tools %}
      <a href="{{ url_for('tool_page', slug=tool.slug) }}"
         class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-4 shadow-sm hover:shadow-lg transition group">

        <div class="flex flex-col items-start gap-2">
          <img src="{{ url_for('static', filename='icons/' ~ tool.icon) }}"
               class="h-10 w-10"
               alt="{{ tool.title }}">

          <h4 class="font-semibold text-sm text-slate-900 dark:text-white group-hover:text-violet-600">
            {{ tool.title }}
          </h4>

          <p class="text-xs text-slate-500 leading-tight">
            {{ tool.desc }}
          </p>
        </div>
      </a>
    {% endfor %}


    <!-- ‚úÖ ALL AI TOOLS -->
    {% for tool in ai_tools %}
    <a href="{{ tool.url }}"
       class="bg-gradient-to-br from-violet-600 to-indigo-600 rounded-xl p-4 shadow-sm hover:shadow-lg transition text-white">

      <div class="flex flex-col items-start gap-2">
        <img src="{{ url_for('static', filename='icons/' ~ tool.icon) }}"
             class="h-10 w-10 invert"
             alt="{{ tool.title }}">

        <h4 class="font-semibold text-sm">
          {{ tool.title }}
        </h4>

        <p class="text-xs opacity-90">
          {{ tool.desc }}
        </p>
      </div>
    </a>
    {% endfor %}

  </div>
</section>
<!-- ========================================================= -->


{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<script>

let canvas = document.getElementById("pdf-canvas");

// ---------------- BASIC TOUCH PAN ----------------
let startX = 0, startY = 0, isDragging = false, lastDist = 0;

// Prevent normal page scroll on touch
if(canvas){
canvas.addEventListener("touchstart", function(e) {
  e.preventDefault();

  if (e.touches.length === 1) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isDragging = true;
  }

  if (e.touches.length === 2) {
    lastDist = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
  }
}, { passive: false });

canvas.addEventListener("touchmove", function(e) {
  e.preventDefault();

  if (e.touches.length === 1 && isDragging) {
    let dx = e.touches[0].clientX - startX;
    let dy = e.touches[0].clientY - startY;

    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;

    canvas.parentElement.scrollLeft -= dx;
    canvas.parentElement.scrollTop -= dy;
  }

}, { passive: false });

canvas.addEventListener("touchend", function () {
  isDragging = false;
});
}

// ---------------- SAFE WRAP TOUCH ----------------

let lastTouchDistance = 0;
let lastTouchX = 0;
let lastTouchY = 0;

const wrap = document.querySelector(".touch-pan");

if (wrap) {
  wrap.addEventListener('touchstart', function(e){
    if(e.touches.length === 2){
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
    }

    if(e.touches.length === 1){
      lastTouchX = e.touches[0].clientX;
      lastTouchY = e.touches[0].clientY;
    }
  }, { passive:false });

  wrap.addEventListener('touchmove', function(e){
    if(e.touches.length === 2){
      e.preventDefault();

      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const newDistance = Math.sqrt(dx * dx + dy * dy);

      if(newDistance > lastTouchDistance){
        zoomIn();
      } else if(newDistance < lastTouchDistance){
        zoomOut();
      }

      lastTouchDistance = newDistance;
    }

    if(e.touches.length === 1){
      const dx = lastTouchX - e.touches[0].clientX;
      const dy = lastTouchY - e.touches[0].clientY;

      wrap.scrollLeft += dx;
      wrap.scrollTop += dy;

      lastTouchX = e.touches[0].clientX;
      lastTouchY = e.touches[0].clientY;
    }
  }, { passive:false });
}

// ---------------- CORE VARIABLES ----------------

let pdfDoc = null;
let currentPage = 1;
let baseWidth = 800;
let isRendering = false;

let fabricCanvas = new fabric.Canvas("pdf-canvas");
let ctx = document.getElementById("pdf-canvas").getContext("2d");

let deleteMode = false;
let cropMode = false;
let cropRect = null;
let selectedTextObj = null;

let history = [];
let historyIndex = -1;
let isRestoring = false;
let isSettingUpPage = false;

/* ========== HISTORY ========== */
function saveState() {
  if (isRestoring || isSettingUpPage || !fabricCanvas) return;

  const json = fabricCanvas.toJSON();
  history = history.slice(0, historyIndex + 1);
  history.push(json);
  historyIndex = history.length - 1;
}

function restoreState(index) {
  if (index < 0 || index >= history.length) return;

  isRestoring = true;
  fabricCanvas.loadFromJSON(history[index], () => {
    fabricCanvas.renderAll();
    isRestoring = false;
  });

  historyIndex = index;
}

function undo() {
  if (historyIndex > 0) restoreState(historyIndex - 1);
}

function redo() {
  if (historyIndex < history.length - 1) restoreState(historyIndex + 1);
}

function resetPage() {
  if (!pdfDoc) return;
  showPage(currentPage);
}

/* Track object changes */
["object:added","object:modified","object:removed"].forEach(ev => {
  fabricCanvas.on(ev, () => saveState());
});

/* ========== PAGE VIEW ========== */
async function showPage(n) {

  if (!pdfDoc || isRendering) return;

  isRendering = true;
  isSettingUpPage = true;
  currentPage = n;

  try {

    const page = await pdfDoc.getPage(n);
    const unscaled = page.getViewport({ scale: 1 });
    const scale = baseWidth / unscaled.width;
    const viewport = page.getViewport({ scale });

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    fabricCanvas.setWidth(viewport.width);
    fabricCanvas.setHeight(viewport.height);

    await page.render({
      canvasContext: ctx,
      viewport: viewport
    }).promise;

    const bg = canvas.toDataURL("image/png");

    fabricCanvas.clear();

    await new Promise(resolve => {
      fabric.Image.fromURL(bg, img => {
        img.selectable = false;
        img.evented = false;
        img.scaleToWidth(fabricCanvas.width);
        img.scaleToHeight(fabricCanvas.height);
        fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas));
        resolve();
      });
    });

    document.getElementById("pageNum").innerText = n;
    document.getElementById("status").innerText = `Page ${n} loaded ‚úÖ`;

    history = [];
    historyIndex = -1;
    isSettingUpPage = false;
    saveState();

  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "‚ùå Error loading page";
  }

  isRendering = false;
}

/* ========== PAGE SWITCH ========== */
function prevPage(){
  if (!pdfDoc || currentPage <= 1) return;
  showPage(currentPage - 1);
}

function nextPage(){
  if (!pdfDoc || currentPage >= pdfDoc.numPages) return;
  showPage(currentPage + 1);
}

/* ========== THUMBNAILS ========== */
async function generateThumbs(){
  const thumbs = document.getElementById("thumbs");
  thumbs.innerHTML = "";

  for(let i = 1; i <= pdfDoc.numPages; i++){
    const page = await pdfDoc.getPage(i);
    const view = page.getViewport({ scale: 0.25 });

    const c = document.createElement("canvas");
    c.width = view.width;
    c.height = view.height;

    await page.render({ canvasContext: c.getContext("2d"), viewport: view }).promise;

    const img = document.createElement("img");
    img.src = c.toDataURL();
    img.className = "border rounded cursor-pointer mb-2 w-full";
    img.onclick = () => showPage(i);

    thumbs.appendChild(img);
  }
}

/* ========== ZOOM ========== */
function zoomIn(){
  baseWidth *= 1.1;
  if(pdfDoc) showPage(currentPage);
}

function zoomOut(){
  baseWidth /= 1.1;
  if(pdfDoc) showPage(currentPage);
}

/* ========== UPLOAD BUTTON FIX (FINAL) ========== */
document.addEventListener("DOMContentLoaded", function(){

  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("pdfUpload");
  const status = document.getElementById("status");

  if(!uploadBtn){
    console.error("uploadBtn not found!");
    return;
  }

  uploadBtn.onclick = async function(){

    const file = fileInput.files[0];

    if(!file){
      alert("Select a PDF first");
      return;
    }

    console.log("‚úÖ Upload button clicked");
    status.innerText = "Loading on canvas...";

    const reader = new FileReader();

    reader.onload = async function(e){
      const bytes = new Uint8Array(e.target.result);
      pdfDoc = await pdfjsLib.getDocument({data: bytes}).promise;

      document.getElementById("pageCount").innerText = pdfDoc.numPages;
      currentPage = 1;

      await showPage(1);
      generateThumbs();

      status.innerText = "‚úÖ PDF loaded on canvas";
    };

    reader.readAsArrayBuffer(file);

    const formData = new FormData();
    formData.append("file", file);

    const res = await fetch("/ai/upload-pdf", {
      method: "POST",
      body: formData
    });

    const result = await res.json();

    if(result.success){
      window.serverPDF = result.filename;
      status.innerText = "‚úÖ Ready for editing";
    } else {
      status.innerText = "‚ùå Upload failed";
    }

  };

});

</script>


{% endblock %}
